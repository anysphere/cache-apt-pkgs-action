name: Pull Request
on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read

jobs:
  integrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version-file: "go.mod"

      - name: Build, lint, and test go binaries
        run: | #shell
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.52.2  # no external gh action deps
          $(go env GOPATH)/bin/golangci-lint run
          go build -v ./...
          go test -v ./...

      - name: Build apt_query binaries
        run: | #shell
          cd src/cmd/apt_query
          GOOS=linux GOARCH=amd64 go build -o ../../../apt_query-x86 .
          GOOS=linux GOARCH=arm64 go build -o ../../../apt_query-arm64 .
          chmod +x ../../../apt_query-x86 ../../../apt_query-arm64
          
      - name: Verify apt_query binary works
        run: | #shell
          sudo apt-get update -qq
          ./apt_query-x86 normalized-list curl wget || echo "Binary failed, checking output..."
          ./apt_query-x86 normalized-list curl wget 2>&1 || true

      - name: Test action (first run - should miss cache)
        id: test-action-1
        uses: ./
        with:
          packages: curl wget
          version: test-pr-${{ github.run_number }}-run1
          debug: 'true'

      - name: Verify action outputs (first run)
        run: | #shell
          echo "Cache hit: ${{ steps.test-action-1.outputs.cache-hit }}"
          echo "Package version list: ${{ steps.test-action-1.outputs.package-version-list }}"
          echo "All package version list: ${{ steps.test-action-1.outputs.all-package-version-list }}"
          
          # Verify outputs are set
          if [ -z "${{ steps.test-action-1.outputs.package-version-list }}" ]; then
            echo "❌ ERROR: package-version-list output is empty"
            exit 1
          fi
          
          # Verify packages are in the output
          if ! echo "${{ steps.test-action-1.outputs.package-version-list }}" | grep -q "curl"; then
            echo "⚠️  WARNING: curl not found in package-version-list"
          fi
          
          if ! echo "${{ steps.test-action-1.outputs.package-version-list }}" | grep -q "wget"; then
            echo "⚠️  WARNING: wget not found in package-version-list"
          fi
          
          # Verify this is a cache miss
          if [ "${{ steps.test-action-1.outputs.cache-hit }}" = "true" ]; then
            echo "❌ ERROR: First run should NOT hit cache, but cache-hit=${{ steps.test-action-1.outputs.cache-hit }}"
            exit 1
          fi
          
          echo "✅ Action outputs verified successfully (cache miss as expected)"

      - name: Test action (second run - should hit cache)
        id: test-action-2
        uses: ./
        with:
          packages: curl wget
          version: test-pr-${{ github.run_number }}-run1
          debug: 'false'

      - name: Verify cache behavior (second run)
        run: | #shell
          echo "Cache hit: ${{ steps.test-action-2.outputs.cache-hit }}"
          echo "Package version list: ${{ steps.test-action-2.outputs.package-version-list }}"
          
          # Verify cache was hit
          if [ "${{ steps.test-action-2.outputs.cache-hit }}" != "true" ]; then
            echo "❌ ERROR: Second run should hit cache, but cache-hit=${{ steps.test-action-2.outputs.cache-hit }}"
            exit 1
          fi
          
          # Verify outputs still work
          if [ -z "${{ steps.test-action-2.outputs.package-version-list }}" ]; then
            echo "❌ ERROR: package-version-list output is empty on cache hit"
            exit 1
          fi
          
          echo "✅ Cache behavior verified successfully (cache hit as expected)"

      - name: Create Aptfile for testing
        run: | 
          cat > Aptfile << 'EOF'
          # Test packages from Aptfile
          git
          ca-certificates
          # Another package
          gnupg
          EOF
          echo "Created Aptfile with contents:"
          cat Aptfile

      - name: Test action with Aptfile (first run - should miss cache)
        id: test-action-aptfile-1
        uses: ./
        with:
          use_aptfile: 'true'
          version: test-pr-aptfile-${{ github.run_number }}-run1
          debug: 'true'

      - name: Verify Aptfile functionality (first run)
        run: | #shell
          echo "Cache hit: ${{ steps.test-action-aptfile-1.outputs.cache-hit }}"
          echo "Package version list: ${{ steps.test-action-aptfile-1.outputs.package-version-list }}"
          echo "All package version list: ${{ steps.test-action-aptfile-1.outputs.all-package-version-list }}"
          
          # Verify outputs are set
          if [ -z "${{ steps.test-action-aptfile-1.outputs.package-version-list }}" ]; then
            echo "❌ ERROR: package-version-list output is empty"
            exit 1
          fi
          
          # Verify packages from Aptfile are in the output (format is package=version, comma-separated)
          package_list="${{ steps.test-action-aptfile-1.outputs.package-version-list }}"
          if ! echo "${package_list}" | grep -qE "(^|,)git="; then
            echo "❌ ERROR: git not found in package-version-list (from Aptfile)"
            echo "Package list: ${package_list}"
            exit 1
          fi
          
          if ! echo "${package_list}" | grep -qE "(^|,)ca-certificates="; then
            echo "❌ ERROR: ca-certificates not found in package-version-list (from Aptfile)"
            echo "Package list: ${package_list}"
            exit 1
          fi
          
          if ! echo "${package_list}" | grep -qE "(^|,)gnupg="; then
            echo "❌ ERROR: gnupg not found in package-version-list (from Aptfile)"
            echo "Package list: ${package_list}"
            exit 1
          fi
          
          # Verify this is a cache miss
          if [ "${{ steps.test-action-aptfile-1.outputs.cache-hit }}" = "true" ]; then
            echo "❌ ERROR: First run should NOT hit cache, but cache-hit=${{ steps.test-action-aptfile-1.outputs.cache-hit }}"
            exit 1
          fi
          
          echo "✅ Aptfile functionality verified successfully (cache miss as expected)"

      - name: Test action with Aptfile (second run - should hit cache)
        id: test-action-aptfile-2
        uses: ./
        with:
          use_aptfile: 'true'
          version: test-pr-aptfile-${{ github.run_number }}-run1
          debug: 'false'

      - name: Verify Aptfile cache behavior (second run)
        run: | #shell
          echo "Cache hit: ${{ steps.test-action-aptfile-2.outputs.cache-hit }}"
          echo "Package version list: ${{ steps.test-action-aptfile-2.outputs.package-version-list }}"
          
          # Verify cache was hit
          if [ "${{ steps.test-action-aptfile-2.outputs.cache-hit }}" != "true" ]; then
            echo "❌ ERROR: Second run should hit cache, but cache-hit=${{ steps.test-action-aptfile-2.outputs.cache-hit }}"
            exit 1
          fi
          
          # Verify outputs still work
          if [ -z "${{ steps.test-action-aptfile-2.outputs.package-version-list }}" ]; then
            echo "❌ ERROR: package-version-list output is empty on cache hit"
            exit 1
          fi
          
          echo "✅ Aptfile cache behavior verified successfully (cache hit as expected)"

      - name: Test action with Aptfile and packages input (merge - first run)
        id: test-action-merge-1
        uses: ./
        with:
          packages: curl
          use_aptfile: 'true'
          version: test-pr-merge-${{ github.run_number }}-run1
          debug: 'true'

      - name: Verify Aptfile and packages merge (first run)
        run: | #shell
          echo "Cache hit: ${{ steps.test-action-merge-1.outputs.cache-hit }}"
          echo "Package version list: ${{ steps.test-action-merge-1.outputs.package-version-list }}"
          
          # Verify outputs are set
          if [ -z "${{ steps.test-action-merge-1.outputs.package-version-list }}" ]; then
            echo "❌ ERROR: package-version-list output is empty"
            exit 1
          fi
          
          # Verify packages from both sources are in the output (format is package=version, comma-separated)
          package_list="${{ steps.test-action-merge-1.outputs.package-version-list }}"
          if ! echo "${package_list}" | grep -qE "(^|,)curl="; then
            echo "❌ ERROR: curl not found in package-version-list (from packages input)"
            echo "Package list: ${package_list}"
            exit 1
          fi
          
          if ! echo "${package_list}" | grep -qE "(^|,)git="; then
            echo "❌ ERROR: git not found in package-version-list (from Aptfile)"
            echo "Package list: ${package_list}"
            exit 1
          fi
          
          # Verify this is a cache miss
          if [ "${{ steps.test-action-merge-1.outputs.cache-hit }}" = "true" ]; then
            echo "❌ ERROR: First run should NOT hit cache, but cache-hit=${{ steps.test-action-merge-1.outputs.cache-hit }}"
            exit 1
          fi
          
          echo "✅ Aptfile and packages merge verified successfully (cache miss as expected)"

      - name: Test action with Aptfile and packages input (merge - second run)
        id: test-action-merge-2
        uses: ./
        with:
          packages: curl
          use_aptfile: 'true'
          version: test-pr-merge-${{ github.run_number }}-run1
          debug: 'false'

      - name: Verify merge cache behavior (second run)
        run: | #shell
          echo "Cache hit: ${{ steps.test-action-merge-2.outputs.cache-hit }}"
          echo "Package version list: ${{ steps.test-action-merge-2.outputs.package-version-list }}"
          
          # Verify cache was hit
          if [ "${{ steps.test-action-merge-2.outputs.cache-hit }}" != "true" ]; then
            echo "❌ ERROR: Second run should hit cache, but cache-hit=${{ steps.test-action-merge-2.outputs.cache-hit }}"
            exit 1
          fi
          
          # Verify outputs still work
          if [ -z "${{ steps.test-action-merge-2.outputs.package-version-list }}" ]; then
            echo "❌ ERROR: package-version-list output is empty on cache hit"
            exit 1
          fi
          
          echo "✅ Merge cache behavior verified successfully (cache hit as expected)"

      - name: Cleanup Aptfile
        if: always()
        run: | #shell
          rm -f Aptfile
